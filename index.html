
<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  background: #f5f6fa;
}

.airport {
  fill: #000;
}


text {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 10px;
  pointer-events: none;
}

svg path.land {
  fill: #CCC;
}

.country {
  fill: #edeffa;
  stroke: #CCC;
}

.red {
  fill: #F00;
}

.none {
  opacity: 0.05;
}

.src {
  fill: #F00;
}

.country:hover {
  
}

.q0-9 { fill:#000000; }
.q1-9 { fill:#000642; }
.q2-9 { fill:#010a6b; }
.q3-9 { fill:#030e8a; }
.q4-9 { fill:#0210ab; }
.q5-9 { fill:#0213cc; }
.q6-9 { fill:#0014f2; }
.q7-9 { fill:#2638ff; }
.q8-9 { fill:#5c69fa; }

</style>
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="geojson/geojson-utils.js"></script>
<script src="underscore.js"></script>
<script>

var minConnections = 0;

var airSpeed = 250; //meters/second
var airportDelay = 7200 //two hours in seconds

var maxDomain = 10000000/airSpeed;

var width = 1200,
    height = 800;

var projection = d3.geo.miller()
    .scale(150)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection)
    .pointRadius(2);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var quantize = d3.scale.quantize()
    .domain([0, maxDomain])
    .range(d3.range(9).map(function(i) { return "q" + i + "-9"; }));

window.startingCity=null;

function planeTimeBetween(src,dest){
  return ( gju.pointDistance(src,dest) / airSpeed ) + airportDelay;
}

d3.json("data/world.json", function(error, world) {

  // draw countries
  svg.selectAll(".country")
    .data(topojson.object(world, world.objects.countries).geometries)
    .enter().append('path')
      .attr("d", path)
      .attr("class", "country")

});

function initializeDijkstras()
{
  for (var l in window.airportLinks)
  {
    airportLinks[l].prev=null;
    airportLinks[l].cost=Infinity;
  }
}

d3.json("data/original/airport.json", function(allAirports) {
  d3.csv("data/routes.csv", function(allRoutes) {
    
    window.airportById = {};
    window.airportLinks = {};

    for (var i=0;i<allAirports.features.length;i++){
      id = allAirports.features[i].properties.airportID;

      airportById[id] = allAirports.features[i];
      airportLinks[id] = {cin:[],cout:[],prev:null,cost:Infinity};
    }


    for (var i=0;i<allRoutes.length;i++)
    {
      var src = allRoutes[i].srcAirportID;
      var dest = allRoutes[i].destAirportID;
      
      if(src != "\\N" && dest != "\\N"){

        var time = planeTimeBetween(airportById[src],airportById[dest]);

        airportLinks[src].cout.push([dest,time]);
        airportLinks[dest].cin.push([src,time]);
      }
    }

    //Maybe this isn't needed
    for(var a in allAirports.features){
      var id = allAirports.features[a].properties.airportID;
      allAirports.features[a].properties.cin = airportLinks[id].cin;
      allAirports.features[a].properties.cout = airportLinks[id].cout;
    }


    var airports = svg.selectAll(".airport")
    .data(allAirports.features)
    .enter().append('path')
      .attr("d", path)
      .attr("class", "airport");

    //On click of an airport
    airports.on("mouseover",function(d){

      var airportID = d.properties.airportID;
      var connectedAirports=[]
      //find all airports connected to d
      for (var i=0;i<allRoutes.length;i++)
      {
        if(allRoutes[i].srcAirportID==airportID)
        {
          connectedAirports.push(allRoutes[i].destAirportID)
        }
      }

      console.log(connectedAirports.length)
      //add a quantization class to each airport
      airports.attr("class",function(e){
        bucket = quantize(planeTimeBetween(e,d))
        if(_.indexOf(connectedAirports,e.properties.airportID) != -1)
        {
          return bucket
        }
        else if (e.properties.airportID == airportID)
          return "red"
        else
          return (bucket + " none")
          //quantize here  gju.pointDistance
      });
    });
  });
});






</script>


<!--

<body>
  <svg width=1200 height=800 class="numer of strings">
    <path d=path() class="place" /> data={}
  </svg>
</body>
-->